stages:
  - build

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  VERSION: $CI_COMMIT_SHORT_SHA
  IMAGE: $CI_REGISTRY_IMAGE
  BUILDX_BUILDER: "builder-$CI_PROJECT_ID"

build-and-push:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
  before_script:
    - apk add --no-cache jq
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - |
      export VERSION=$(jq -r .version package.json)
      echo "VERSION=$VERSION" >> build.env
    - |
      # Create and reuse buildx builder (persists across pipelines for better cache performance)
      # Check if builder exists, create if not, then use it
      if ! docker buildx ls | grep -q "$BUILDX_BUILDER"; then
        docker buildx create --name $BUILDX_BUILDER --driver docker-container --use --driver-opt network=host
      else
        docker buildx use $BUILDX_BUILDER
      fi
      docker buildx inspect --bootstrap
  script:
    - source build.env
    - |
      # Extract metadata for tags
      SHORT_SHA=$CI_COMMIT_SHORT_SHA
      TAGS="$CI_REGISTRY_IMAGE:$SHORT_SHA"
      TAGS="$TAGS $CI_REGISTRY_IMAGE:latest"
      if [ -n "$VERSION" ] && [ "$VERSION" != "null" ]; then
        TAGS="$TAGS $CI_REGISTRY_IMAGE:v$VERSION"
      fi
      
      # Build tags string for docker buildx
      TAG_ARGS=""
      for tag in $TAGS; do
        TAG_ARGS="$TAG_ARGS -t $tag"
      done
      
      # Build and push (only push if not a merge request)
      if [ "$CI_PIPELINE_SOURCE" != "merge_request_event" ]; then
        # Multi-platform build with optimized registry cache
        # Buildx handles parallel platform builds internally for better performance
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --file ./Dockerfile \
          $TAG_ARGS \
          --push \
          --cache-from type=registry,ref=$CI_REGISTRY_IMAGE:buildcache \
          --cache-to type=registry,ref=$CI_REGISTRY_IMAGE:buildcache,mode=max \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --provenance=false \
          --sbom=false \
          .
      else
        # For merge requests, just build without pushing (single platform for speed)
        docker buildx build \
          --platform linux/amd64 \
          --file ./Dockerfile \
          $TAG_ARGS \
          --load \
          --cache-from type=registry,ref=$CI_REGISTRY_IMAGE:buildcache \
          .
      fi
  after_script:
    - docker logout $CI_REGISTRY || true
